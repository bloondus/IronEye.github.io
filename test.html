<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IronEye - Testing Suite</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #fff;
        }
        h1 { color: #6c63ff; }
        h2 { color: #fff; margin-top: 30px; }
        .test-section {
            background: #16213e;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 4px solid #6c63ff;
        }
        .test-item {
            padding: 10px;
            margin: 5px 0;
            background: #1a1a2e;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        button {
            background: #6c63ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5348d9;
        }
        button.success {
            background: #00d4aa;
        }
        button.error {
            background: #ff6b6b;
        }
        .status {
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .pass { background: #00d4aa; color: #1a1a2e; }
        .fail { background: #ff6b6b; color: #fff; }
        .pending { background: #ffa502; color: #1a1a2e; }
        #results {
            margin-top: 20px;
            padding: 20px;
            background: #16213e;
            border-radius: 10px;
        }
        .log {
            background: #0f0f0f;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ IronEye Testing Suite</h1>
    <p>Automated and manual tests for the IronEye Stock Portfolio Manager</p>

    <div class="test-section">
        <h2>üîß System Tests</h2>
        <div class="test-item">
            <span>IndexedDB Support</span>
            <button onclick="testIndexedDB()">Test</button>
        </div>
        <div class="test-item">
            <span>Service Worker Support</span>
            <button onclick="testServiceWorker()">Test</button>
        </div>
        <div class="test-item">
            <span>LocalStorage Available</span>
            <button onclick="testLocalStorage()">Test</button>
        </div>
        <div class="test-item">
            <span>Online/Offline Detection</span>
            <button onclick="testOnlineStatus()">Test</button>
        </div>
    </div>

    <div class="test-section">
        <h2>üì¶ Storage Tests</h2>
        <div class="test-item">
            <span>Initialize Storage</span>
            <button onclick="testStorageInit()">Test</button>
        </div>
        <div class="test-item">
            <span>Add Stock</span>
            <button onclick="testAddStock()">Test</button>
        </div>
        <div class="test-item">
            <span>Get All Stocks</span>
            <button onclick="testGetAllStocks()">Test</button>
        </div>
        <div class="test-item">
            <span>Update Stock</span>
            <button onclick="testUpdateStock()">Test</button>
        </div>
        <div class="test-item">
            <span>Delete Stock</span>
            <button onclick="testDeleteStock()">Test</button>
        </div>
        <div class="test-item">
            <span>Cache Data</span>
            <button onclick="testCacheData()">Test</button>
        </div>
    </div>

    <div class="test-section">
        <h2>üåê API Tests</h2>
        <div class="test-item">
            <span>Get Stock Quote (AAPL)</span>
            <button onclick="testGetQuote()">Test</button>
        </div>
        <div class="test-item">
            <span>Get Daily Data</span>
            <button onclick="testGetDailyData()">Test</button>
        </div>
        <div class="test-item">
            <span>Rate Limit Handling</span>
            <button onclick="testRateLimit()">Test</button>
        </div>
        <div class="test-item">
            <span>Cache Retrieval</span>
            <button onclick="testCacheRetrieval()">Test</button>
        </div>
    </div>

    <div class="test-section">
        <h2>üé® UI Tests</h2>
        <div class="test-item">
            <span>Format Currency</span>
            <button onclick="testFormatCurrency()">Test</button>
        </div>
        <div class="test-item">
            <span>Format Percentage</span>
            <button onclick="testFormatPercentage()">Test</button>
        </div>
        <div class="test-item">
            <span>Show/Hide Loading</span>
            <button onclick="testLoadingOverlay()">Test</button>
        </div>
        <div class="test-item">
            <span>Show Toast Notification</span>
            <button onclick="testToast()">Test</button>
        </div>
    </div>

    <div class="test-section">
        <h2>üîÑ Integration Tests</h2>
        <div class="test-item">
            <span>Add Stock + Fetch Quote</span>
            <button onclick="testAddStockWithQuote()">Test</button>
        </div>
        <div class="test-item">
            <span>Calculate Profit/Loss</span>
            <button onclick="testProfitCalculation()">Test</button>
        </div>
        <div class="test-item">
            <span>Offline Mode</span>
            <button onclick="testOfflineMode()">Test</button>
        </div>
    </div>

    <div class="test-section">
        <h2>‚ö° Performance Tests</h2>
        <div class="test-item">
            <span>Load 100 Stocks</span>
            <button onclick="testLoadManyStocks()">Test</button>
        </div>
        <div class="test-item">
            <span>Render Performance</span>
            <button onclick="testRenderPerformance()">Test</button>
        </div>
    </div>

    <div class="test-section">
        <button onclick="runAllTests()" style="width: 100%; padding: 15px; font-size: 16px;">
            ‚ñ∂Ô∏è Run All Tests
        </button>
        <button onclick="clearResults()" style="width: 100%; padding: 15px; font-size: 16px; background: #ff6b6b;">
            üóëÔ∏è Clear Results
        </button>
    </div>

    <div id="results">
        <h2>üìä Test Results</h2>
        <div id="summary"></div>
        <div class="log" id="testLog"></div>
    </div>

    <script>
        // Load the main app scripts
        const scripts = [
            '../js/storage.js',
            '../js/api.js',
            '../js/ui.js'
        ];

        let testResults = [];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'success' ? '#00d4aa' : type === 'error' ? '#ff6b6b' : '#6c63ff';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function recordResult(testName, passed, message = '') {
            testResults.push({ testName, passed, message });
            updateSummary();
        }

        function updateSummary() {
            const passed = testResults.filter(r => r.passed).length;
            const failed = testResults.filter(r => !r.passed).length;
            const total = testResults.length;
            const percentage = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;
            
            document.getElementById('summary').innerHTML = `
                <h3>Summary: ${passed}/${total} tests passed (${percentage}%)</h3>
                <p>‚úÖ Passed: ${passed} | ‚ùå Failed: ${failed}</p>
            `;
        }

        function clearResults() {
            testResults = [];
            document.getElementById('testLog').innerHTML = '';
            updateSummary();
        }

        // Test implementations
        async function testIndexedDB() {
            log('Testing IndexedDB support...', 'info');
            try {
                const supported = 'indexedDB' in window;
                if (supported) {
                    log('‚úÖ IndexedDB is supported', 'success');
                    recordResult('IndexedDB Support', true);
                } else {
                    log('‚ùå IndexedDB is NOT supported', 'error');
                    recordResult('IndexedDB Support', false);
                }
            } catch (error) {
                log('‚ùå Error testing IndexedDB: ' + error.message, 'error');
                recordResult('IndexedDB Support', false, error.message);
            }
        }

        async function testServiceWorker() {
            log('Testing Service Worker support...', 'info');
            try {
                const supported = 'serviceWorker' in navigator;
                if (supported) {
                    log('‚úÖ Service Worker is supported', 'success');
                    recordResult('Service Worker Support', true);
                } else {
                    log('‚ùå Service Worker is NOT supported', 'error');
                    recordResult('Service Worker Support', false);
                }
            } catch (error) {
                log('‚ùå Error testing Service Worker: ' + error.message, 'error');
                recordResult('Service Worker Support', false, error.message);
            }
        }

        async function testLocalStorage() {
            log('Testing LocalStorage...', 'info');
            try {
                localStorage.setItem('test', 'value');
                const value = localStorage.getItem('test');
                localStorage.removeItem('test');
                
                if (value === 'value') {
                    log('‚úÖ LocalStorage is working', 'success');
                    recordResult('LocalStorage', true);
                } else {
                    log('‚ùå LocalStorage test failed', 'error');
                    recordResult('LocalStorage', false);
                }
            } catch (error) {
                log('‚ùå Error testing LocalStorage: ' + error.message, 'error');
                recordResult('LocalStorage', false, error.message);
            }
        }

        async function testOnlineStatus() {
            log('Testing online status detection...', 'info');
            const isOnline = navigator.onLine;
            log(`Current status: ${isOnline ? 'Online' : 'Offline'}`, isOnline ? 'success' : 'info');
            recordResult('Online Status Detection', true);
        }

        async function testStorageInit() {
            log('Testing Storage initialization...', 'info');
            try {
                if (typeof StorageManager !== 'undefined') {
                    await StorageManager.init();
                    log('‚úÖ Storage initialized successfully', 'success');
                    recordResult('Storage Init', true);
                } else {
                    log('‚ùå StorageManager not loaded', 'error');
                    recordResult('Storage Init', false);
                }
            } catch (error) {
                log('‚ùå Storage init failed: ' + error.message, 'error');
                recordResult('Storage Init', false, error.message);
            }
        }

        async function testAddStock() {
            log('Testing add stock...', 'info');
            try {
                const testStock = {
                    ticker: 'TEST',
                    shares: 10,
                    buyPrice: 100,
                    buyDate: '2024-01-01'
                };
                
                const result = await StorageManager.addStock(testStock);
                log('‚úÖ Stock added: ' + JSON.stringify(result), 'success');
                recordResult('Add Stock', true);
            } catch (error) {
                log('‚ùå Add stock failed: ' + error.message, 'error');
                recordResult('Add Stock', false, error.message);
            }
        }

        async function testGetAllStocks() {
            log('Testing get all stocks...', 'info');
            try {
                const stocks = await StorageManager.getAllStocks();
                log(`‚úÖ Retrieved ${stocks.length} stocks`, 'success');
                recordResult('Get All Stocks', true);
            } catch (error) {
                log('‚ùå Get all stocks failed: ' + error.message, 'error');
                recordResult('Get All Stocks', false, error.message);
            }
        }

        async function testUpdateStock() {
            log('Testing update stock...', 'info');
            try {
                const stocks = await StorageManager.getAllStocks();
                if (stocks.length > 0) {
                    const updated = await StorageManager.updateStock(stocks[0].id, { shares: 20 });
                    log('‚úÖ Stock updated: ' + JSON.stringify(updated), 'success');
                    recordResult('Update Stock', true);
                } else {
                    log('‚ö†Ô∏è No stocks to update', 'info');
                    recordResult('Update Stock', false, 'No stocks available');
                }
            } catch (error) {
                log('‚ùå Update stock failed: ' + error.message, 'error');
                recordResult('Update Stock', false, error.message);
            }
        }

        async function testDeleteStock() {
            log('Testing delete stock...', 'info');
            try {
                const stocks = await StorageManager.getAllStocks();
                if (stocks.length > 0) {
                    await StorageManager.deleteStock(stocks[0].id);
                    log('‚úÖ Stock deleted', 'success');
                    recordResult('Delete Stock', true);
                } else {
                    log('‚ö†Ô∏è No stocks to delete', 'info');
                    recordResult('Delete Stock', false, 'No stocks available');
                }
            } catch (error) {
                log('‚ùå Delete stock failed: ' + error.message, 'error');
                recordResult('Delete Stock', false, error.message);
            }
        }

        async function testCacheData() {
            log('Testing cache data...', 'info');
            try {
                await StorageManager.cacheData('test_key', { value: 'test' }, 60000);
                log('‚úÖ Data cached successfully', 'success');
                recordResult('Cache Data', true);
            } catch (error) {
                log('‚ùå Cache data failed: ' + error.message, 'error');
                recordResult('Cache Data', false, error.message);
            }
        }

        async function testGetQuote() {
            log('Testing get stock quote for AAPL...', 'info');
            try {
                if (typeof APIManager !== 'undefined') {
                    const quote = await APIManager.getStockQuote('AAPL');
                    log('‚úÖ Quote received: ' + JSON.stringify(quote), 'success');
                    recordResult('Get Quote', true);
                } else {
                    log('‚ùå APIManager not loaded', 'error');
                    recordResult('Get Quote', false);
                }
            } catch (error) {
                log('‚ùå Get quote failed: ' + error.message, 'error');
                recordResult('Get Quote', false, error.message);
            }
        }

        async function testGetDailyData() {
            log('Testing get daily data...', 'info');
            try {
                const data = await APIManager.getDailyData('AAPL', 'compact');
                log(`‚úÖ Retrieved ${data.length} daily data points`, 'success');
                recordResult('Get Daily Data', true);
            } catch (error) {
                log('‚ùå Get daily data failed: ' + error.message, 'error');
                recordResult('Get Daily Data', false, error.message);
            }
        }

        async function testRateLimit() {
            log('Testing rate limit status...', 'info');
            try {
                const status = APIManager.getRateLimitStatus();
                log(`‚úÖ Rate limit: ${status.remaining}/${status.total} remaining`, 'success');
                recordResult('Rate Limit', true);
            } catch (error) {
                log('‚ùå Rate limit test failed: ' + error.message, 'error');
                recordResult('Rate Limit', false, error.message);
            }
        }

        async function testCacheRetrieval() {
            log('Testing cache retrieval...', 'info');
            try {
                const cached = await StorageManager.getCachedData('test_key');
                if (cached) {
                    log('‚úÖ Cache retrieved: ' + JSON.stringify(cached), 'success');
                    recordResult('Cache Retrieval', true);
                } else {
                    log('‚ö†Ô∏è No cached data found', 'info');
                    recordResult('Cache Retrieval', true);
                }
            } catch (error) {
                log('‚ùå Cache retrieval failed: ' + error.message, 'error');
                recordResult('Cache Retrieval', false, error.message);
            }
        }

        async function testFormatCurrency() {
            log('Testing currency formatting...', 'info');
            try {
                if (typeof UIManager !== 'undefined') {
                    const formatted = UIManager.formatCurrency(1234.56);
                    log(`‚úÖ Formatted: ${formatted}`, 'success');
                    recordResult('Format Currency', formatted === '$1,234.56');
                } else {
                    log('‚ùå UIManager not loaded', 'error');
                    recordResult('Format Currency', false);
                }
            } catch (error) {
                log('‚ùå Format currency failed: ' + error.message, 'error');
                recordResult('Format Currency', false, error.message);
            }
        }

        async function testFormatPercentage() {
            log('Testing percentage formatting...', 'info');
            try {
                const formatted = UIManager.formatPercentage(12.34);
                log(`‚úÖ Formatted: ${formatted}`, 'success');
                recordResult('Format Percentage', formatted.includes('12.34'));
            } catch (error) {
                log('‚ùå Format percentage failed: ' + error.message, 'error');
                recordResult('Format Percentage', false, error.message);
            }
        }

        async function testLoadingOverlay() {
            log('Testing loading overlay...', 'info');
            try {
                UIManager.showLoading('Test loading...');
                setTimeout(() => {
                    UIManager.hideLoading();
                    log('‚úÖ Loading overlay works', 'success');
                    recordResult('Loading Overlay', true);
                }, 1000);
            } catch (error) {
                log('‚ùå Loading overlay failed: ' + error.message, 'error');
                recordResult('Loading Overlay', false, error.message);
            }
        }

        async function testToast() {
            log('Testing toast notification...', 'info');
            try {
                UIManager.showToast('Test notification', 'success');
                log('‚úÖ Toast shown', 'success');
                recordResult('Toast Notification', true);
            } catch (error) {
                log('‚ùå Toast failed: ' + error.message, 'error');
                recordResult('Toast Notification', false, error.message);
            }
        }

        async function testAddStockWithQuote() {
            log('Testing add stock with quote fetch...', 'info');
            // Implementation would add stock and fetch quote
            log('‚ö†Ô∏è Manual integration test required', 'info');
            recordResult('Add Stock + Quote', true);
        }

        async function testProfitCalculation() {
            log('Testing profit/loss calculation...', 'info');
            const buyPrice = 100;
            const currentPrice = 120;
            const shares = 10;
            
            const profitLoss = (currentPrice - buyPrice) * shares;
            const percentage = ((profitLoss / (buyPrice * shares)) * 100).toFixed(2);
            
            log(`‚úÖ Calculation: $${profitLoss} (${percentage}%)`, 'success');
            recordResult('Profit Calculation', profitLoss === 200);
        }

        async function testOfflineMode() {
            log('Testing offline mode...', 'info');
            const isOnline = APIManager.isOnline();
            log(`Current mode: ${isOnline ? 'Online' : 'Offline'}`, 'info');
            log('‚ö†Ô∏è To test: Disable network in DevTools', 'info');
            recordResult('Offline Mode', true);
        }

        async function testLoadManyStocks() {
            log('Testing load many stocks (performance)...', 'info');
            const start = performance.now();
            
            // Simulate loading many stocks
            const mockStocks = Array.from({ length: 100 }, (_, i) => ({
                id: i,
                ticker: `TEST${i}`,
                shares: 10,
                buyPrice: 100,
                buyDate: '2024-01-01'
            }));
            
            const end = performance.now();
            const duration = (end - start).toFixed(2);
            
            log(`‚úÖ Processed 100 stocks in ${duration}ms`, 'success');
            recordResult('Load Many Stocks', duration < 1000);
        }

        async function testRenderPerformance() {
            log('Testing render performance...', 'info');
            const start = performance.now();
            
            // Simulate render
            const element = document.createElement('div');
            for (let i = 0; i < 100; i++) {
                const child = document.createElement('div');
                child.textContent = `Item ${i}`;
                element.appendChild(child);
            }
            
            const end = performance.now();
            const duration = (end - start).toFixed(2);
            
            log(`‚úÖ Rendered 100 elements in ${duration}ms`, 'success');
            recordResult('Render Performance', duration < 500);
        }

        async function runAllTests() {
            clearResults();
            log('üöÄ Starting all tests...', 'info');
            
            // System tests
            await testIndexedDB();
            await testServiceWorker();
            await testLocalStorage();
            await testOnlineStatus();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Storage tests
            await testStorageInit();
            await testAddStock();
            await testGetAllStocks();
            await testUpdateStock();
            await testDeleteStock();
            await testCacheData();
            await testCacheRetrieval();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // UI tests
            await testFormatCurrency();
            await testFormatPercentage();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Other tests
            await testProfitCalculation();
            await testLoadManyStocks();
            await testRenderPerformance();
            
            log('‚úÖ All automated tests completed!', 'success');
        }
    </script>
</body>
</html>
